import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Button } from '@/components/ui/button';
import { Plus, Target, CheckCircle } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { Tabs, TabsList, TabsTrigger } from '@/components/ui/tabs';
import DreamCard from '../components/dreams/DreamCard';
import DreamForm from '../components/dreams/DreamForm';
import MilestoneForm from '../components/dreams/MilestoneForm';
import CelebrationModal from '../components/dreams/CelebrationModal';

export default function DreamsPage() {
  const queryClient = useQueryClient();
  const [showForm, setShowForm] = useState(false);
  const [editingDream, setEditingDream] = useState(null);
  const [showMilestoneForm, setShowMilestoneForm] = useState(false);
  const [selectedDream, setSelectedDream] = useState(null);
  const [filter, setFilter] = useState('all');
  const [celebrationDream, setCelebrationDream] = useState(null);
  const [showCelebration, setShowCelebration] = useState(false);

  const { data: dreams = [] } = useQuery({
    queryKey: ['dreams'],
    queryFn: () => base44.entities.Dream.list('-created_date'),
  });

  const { data: milestones = [] } = useQuery({
    queryKey: ['milestones'],
    queryFn: () => base44.entities.Milestone.list('-created_date'),
  });

  const { data: reflections = [] } = useQuery({
    queryKey: ['reflections'],
    queryFn: () => base44.entities.Reflection.list('-date'),
  });

  const { data: user } = useQuery({
    queryKey: ['me'],
    queryFn: () => base44.auth.me(),
  });

  const createDreamMutation = useMutation({
    mutationFn: async (dreamData) => {
      const result = await base44.entities.Dream.create(dreamData);
      // Award 2 stars for adding a dream
      await base44.auth.updateMe({
        total_stars: (user?.total_stars || 0) + 2,
      });
      return result;
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['dreams']);
      queryClient.invalidateQueries(['me']);
      setShowForm(false);
      setEditingDream(null);
    },
  });

  const updateDreamMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.Dream.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries(['dreams']);
      setShowForm(false);
      setEditingDream(null);
    },
  });

  const deleteDreamMutation = useMutation({
    mutationFn: (id) => base44.entities.Dream.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries(['dreams']);
    },
  });

  const createMilestoneMutation = useMutation({
    mutationFn: async (milestoneData) => {
      const result = await base44.entities.Milestone.create(milestoneData);
      // Award 1 star for completing a milestone
      if (milestoneData.status === 'completed') {
        await base44.auth.updateMe({
          total_stars: (user?.total_stars || 0) + 1,
        });
      }
      return result;
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['milestones']);
      queryClient.invalidateQueries(['me']);
      setShowMilestoneForm(false);
      setSelectedDream(null);
    },
  });

  const deleteMilestoneMutation = useMutation({
    mutationFn: async (milestone) => {
      // If milestone was completed, deduct the star
      if (milestone.status === 'completed') {
        await base44.auth.updateMe({
          total_stars: Math.max((user?.total_stars || 0) - 1, 0),
        });
      }
      await base44.entities.Milestone.delete(milestone.id);
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['milestones']);
      queryClient.invalidateQueries(['me']);
    },
  });

  const handleSave = (dreamData) => {
    if (editingDream) {
      updateDreamMutation.mutate({ id: editingDream.id, data: dreamData });
    } else {
      createDreamMutation.mutate(dreamData);
    }
  };

  const handleToggleStatus = async (dream) => {
    const newStatus = dream.status === 'completed' ? 'in_progress' : 'completed';
    const updateData = {
      ...dream,
      status: newStatus,
      completed_date: newStatus === 'completed' ? new Date().toISOString().split('T')[0] : null,
    };

    await updateDreamMutation.mutateAsync({ id: dream.id, data: updateData });

    // Award 3 stars for completing a dream
    if (newStatus === 'completed') {
      await base44.auth.updateMe({
        total_stars: (user?.total_stars || 0) + 3,
      });
      queryClient.invalidateQueries(['me']);
      
      // Show celebration modal
      setCelebrationDream(dream);
      setShowCelebration(true);
    }
  };

  const handleShare = () => {
    if (!celebrationDream) return;
    
    const shareText = `ðŸŽ‰ I just achieved my dream: "${celebrationDream.title}" on DAYLIFE! Every day counts. What will you do with yours? #DAYLIFE #DreamAchieved`;
    const shareUrl = window.location.origin;
    
    if (navigator.share) {
      navigator.share({
        title: 'Dream Achieved on DAYLIFE',
        text: shareText,
        url: shareUrl,
      }).catch(() => {});
    } else {
      // Fallback: Open Twitter share
      const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`;
      window.open(twitterUrl, '_blank');
    }
  };

  const handleEdit = (dream) => {
    setEditingDream(dream);
    setShowForm(true);
  };

  const handleDelete = (dream) => {
    if (confirm('Are you sure you want to delete this dream?')) {
      deleteDreamMutation.mutate(dream.id);
    }
  };

  const handleAddMilestone = (dream) => {
    setSelectedDream(dream);
    setShowMilestoneForm(true);
  };

  const handleSaveMilestone = (milestoneData) => {
    createMilestoneMutation.mutate(milestoneData);
  };

  const handleDeleteMilestone = (milestone) => {
    const message = milestone.status === 'completed'
      ? 'This milestone is completed and you earned 1 star for it. Deleting it will deduct 1 star. Continue?'
      : 'Are you sure you want to delete this milestone?';

    if (confirm(message)) {
      deleteMilestoneMutation.mutate(milestone);
    }
  };

  const filteredDreams = dreams.filter(dream => {
    if (filter === 'all') return true;
    return dream.status === filter;
  });

  const inProgressCount = dreams.filter(d => d.status === 'in_progress').length;
  const completedCount = dreams.filter(d => d.status === 'completed').length;

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">
      <div className="max-w-6xl mx-auto p-4 md:p-8 space-y-8">
        {/* Header */}
        <motion.div
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          className="text-center"
        >
          <h1 className="text-3xl md:text-4xl font-bold text-slate-800 mb-2">Your Dreams</h1>
          <p className="text-slate-600 mb-6">Turn your days into dreams, and your dreams into days</p>

          <Button
            onClick={() => {
              setEditingDream(null);
              setShowForm(true);
            }}
            className="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700"
          >
            <Plus className="w-5 h-5 mr-2" />
            Add Dream
          </Button>
        </motion.div>

        {/* Stats */}
        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
          <motion.div
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            className="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm text-center"
          >
            <Target className="w-8 h-8 text-blue-500 mb-2 mx-auto" />
            <div className="text-3xl font-bold text-slate-800">{inProgressCount}</div>
            <div className="text-sm text-slate-600">In Progress</div>
          </motion.div>

          <motion.div
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ delay: 0.1 }}
            className="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm text-center"
          >
            <CheckCircle className="w-8 h-8 text-green-500 mb-2 mx-auto" />
            <div className="text-3xl font-bold text-slate-800">{completedCount}</div>
            <div className="text-sm text-slate-600">Completed</div>
          </motion.div>

          <motion.div
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ delay: 0.2 }}
            className="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm col-span-2 md:col-span-1 text-center"
          >
            <div className="text-3xl font-bold text-slate-800">{dreams.length}</div>
            <div className="text-sm text-slate-600">Total Dreams</div>
          </motion.div>
        </div>

        {/* Filter Tabs */}
        <div className="flex justify-center">
          <Tabs value={filter} onValueChange={setFilter}>
            <TabsList className="bg-white border border-slate-200">
              <TabsTrigger value="all">All ({dreams.length})</TabsTrigger>
              <TabsTrigger value="in_progress">In Progress ({inProgressCount})</TabsTrigger>
              <TabsTrigger value="completed">Completed ({completedCount})</TabsTrigger>
            </TabsList>
          </Tabs>
        </div>

        {/* Dreams Grid */}
        <div className="grid md:grid-cols-2 gap-4">
          <AnimatePresence>
            {filteredDreams.map((dream) => (
              <DreamCard
                key={dream.id}
                dream={dream}
                milestones={milestones}
                reflections={reflections}
                onToggleStatus={handleToggleStatus}
                onEdit={handleEdit}
                onDelete={handleDelete}
                onAddMilestone={handleAddMilestone}
                onDeleteMilestone={handleDeleteMilestone}
              />
            ))}
          </AnimatePresence>
        </div>

        {filteredDreams.length === 0 && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            className="text-center py-16"
          >
            <Target className="w-16 h-16 text-slate-400 mx-auto mb-4" />
            <h3 className="text-xl text-slate-600 mb-2">No dreams yet</h3>
            <p className="text-slate-500 mb-6">Start by adding your first dream or goal</p>
            <Button
              onClick={() => {
                setEditingDream(null);
                setShowForm(true);
              }}
              className="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700"
            >
              <Plus className="w-5 h-5 mr-2" />
              Add Your First Dream
            </Button>
          </motion.div>
        )}

        {/* Dream Form Dialog */}
        <DreamForm
          open={showForm}
          onClose={() => {
            setShowForm(false);
            setEditingDream(null);
          }}
          onSave={handleSave}
          dream={editingDream}
        />

        {/* Milestone Form Dialog */}
        <MilestoneForm
          open={showMilestoneForm}
          onClose={() => {
            setShowMilestoneForm(false);
            setSelectedDream(null);
          }}
          onSave={handleSaveMilestone}
          dreamId={selectedDream?.id}
        />

        {/* Celebration Modal */}
        <CelebrationModal
          open={showCelebration}
          onClose={() => {
            setShowCelebration(false);
            setCelebrationDream(null);
          }}
          dream={celebrationDream}
          onShare={handleShare}
        />
      </div>
    </div>
  );
}
